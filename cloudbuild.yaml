steps:
#Step 1. Build project
- id: Build project
  name: maven:3-jdk-11
  entrypoint: mvn
  args: ['clean','install', '-DskipTests=true']

#Step 2. Test project
- id: Test project
  name: maven:3-jdk-11
  entrypoint: mvn
  args: ['test']

# Install Cloud SQL proxy
- id: proxy-install
  name: maven:3-jdk-11
  entrypoint: sh
  args:
    - "-c"
    - "wget https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64 -O cloud_sql_proxy && chmod +x cloud_sql_proxy"

# Migrate database schema to the latest version
- id: migrate
  name: maven:3-jdk-11
  entrypoint: sh
  args:
    - "-c"
    - "./cloud_sql_proxy -instances=gcp-project-322518:us-central1:postgre-instance=tcp:localhost:5432 && mvn liquibase:update -Dliquibase.url=jdbc:postgresql://localhost/postgres -Dliquibase.username=postgres -Dliquibase.password=1234"
  timeout: "1200s"
  waitFor: ["proxy-install"]

#Step 3. Build docker image
- id: Build docker image
  name: 'gcr.io/cloud-builders/docker'
  args: [ 'build', '-t', 'us-central1-docker.pkg.dev/gcp-project-322518/gcp-project-docker-repo/gcp-project:$SHORT_SHA', '.' ]

#Step 4. Push docker image
- id: Push docker image
  name: 'gcr.io/cloud-builders/docker'
  args: [ 'push', 'us-central1-docker.pkg.dev/gcp-project-322518/gcp-project-docker-repo/gcp-project:$SHORT_SHA' ]

#Step 5. Update Image Tag
- id: Update Image Tag
  name: ubuntu
  args: [ 'bash','-c','sed -i "s|INIT_IMAGE_NAME|us-central1-docker.pkg.dev/gcp-project-322518/gcp-project-docker-repo/gcp-project:$SHORT_SHA|" k8s/deployment.yaml' ]

#Step 6. Updating Deployment
- id: Updating Deployment
  name: gcr.io/cloud-builders/kubectl
  args: ['apply','-f','k8s/deployment.yaml']
  env:
    - CLOUDSDK_COMPUTE_ZONE=us-central1-a
    - CLOUDSDK_CONTAINER_CLUSTER=nginx-1-cluster
images: ['us-central1-docker.pkg.dev/gcp-project-322518/gcp-project-docker-repo/gcp-project:$SHORT_SHA']